# PCASL-simulation
These scripts simulate a blood proton experiencing adiabatic inversion as in pseudo-continuous arterial spin labeling. The simulations are based on [Maccotta et al., 1999](https://doi.org/10.1002/(SICI)1099-1492(199706/08)10:4/5%3C216::AID-NBM468%3E3.0.CO;2-U) and [Dai et al., 2008](https://doi.org/10.1002/mrm.21790).

* The main simulation script is **sim_inversion.m** which is a function that takes a gradient shape, RF shape, and a structure of simulation parameters as input. The simulation works by performing finite rotations of the magnetization vector **M** around the effective magnetic field in the rotating reference frame where the rotational frequency is $\omega_{RF}$. This script is a functionalized version of pcasl_simulation.m
* **sim_inversion_call.m** creates RF and gradient waveforms and initializes simulation parameters to pass to **sim_inversion()** which is called for multiple spin velocities. The $M_z$ trajectories for each velocity are plotted as a function of time. You can see that slower spins generally experience less inversion. This script also computes labeling efficiency. Assuming laminar blood flow, the labeling efficiency within a vessel is computed based on the velocity-weighted average of efficiencies of individual spins having different velocities. <br/> <p align="center"> $$\alpha_{vessel} = \frac{2}{v_{max}^2} \int_0^{v_{max}} v*\alpha(v)dv$$ </p> 
   where $$v_{max}$$ is the maximum velocity within the vessel, $$v$$ is the velocity of a spin, and $$\alpha(v)$$ is the labeling efficiency of spin with velocity $$v$$ and is defined as <br/> <p align="center"> $$\alpha(v) = \frac{M_0 - M_{z}}{2*M_0}$$ </p> where $$M_0$$ is the equilbrium longitudinal magnetization. Before computing labeling efficiency for one velocity, the longitudinal magnetization $$M_z$$ is corrected for $T_1$ decay that occurs during transit: <br/> <p align="center"> $$M_{{z}_{corrected}} = \frac{M_z - M_0}{exp(-t/T_1)} + M_0$$</p>
  where $$t$$ is the transit time or the time at the end of the simulation, and $$T_1$$ is the longitudinal relaxation time of blood.
* **maccotta_simulation.m** is the CASL simulation.
